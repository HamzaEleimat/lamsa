#!/bin/sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-commit security checks..."

# Check for exposed secrets
echo "Checking for exposed secrets..."

# Check staged files
STAGED_FILES=$(git diff --cached --name-only)
SECRETS_FOUND=0

# Check for common secret patterns
check_pattern() {
    pattern="$1"
    # Exclude .husky directory, .md files, .env.example files, and scripts directory
    if echo "$STAGED_FILES" | grep -v "^\.husky/" | grep -v "\.md$" | grep -v "\.env\.example$" | grep -v "\.env\..*\.template$" | grep -v "^scripts/" | xargs grep -l "$pattern" 2>/dev/null; then
        echo "üö® SECURITY ALERT: Potential secret found matching pattern: $pattern"
        echo "Files containing potential secrets:"
        echo "$STAGED_FILES" | grep -v "^\.husky/" | grep -v "\.md$" | grep -v "\.env\.example$" | grep -v "\.env\..*\.template$" | grep -v "^scripts/" | xargs grep -l "$pattern" 2>/dev/null
        SECRETS_FOUND=1
    fi
}

# Common secret patterns
check_pattern "sk_live_"
check_pattern "pk_live_"
check_pattern "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9"
check_pattern "supabase\.co"
check_pattern "SUPABASE_SERVICE_KEY=[^_]"
check_pattern "JWT_SECRET=[a-zA-Z0-9]\{32,\}"
check_pattern "password\s*[=:]\s*['\"][^'\"]\{8,\}['\"]"
check_pattern "secret\s*[=:]\s*['\"][^'\"]\{8,\}['\"]"
check_pattern "token\s*[=:]\s*['\"][^'\"]\{16,\}['\"]"
check_pattern "key\s*[=:]\s*['\"][^'\"]\{16,\}['\"]"

# Check for .env files
if echo "$STAGED_FILES" | grep -E "\.env$|\.env\.production$|\.env\.local$" >/dev/null; then
    echo "üö® SECURITY ALERT: .env files should not be committed!"
    echo "Found .env files in staged changes:"
    echo "$STAGED_FILES" | grep -E "\.env$|\.env\.production$|\.env\.local$"
    SECRETS_FOUND=1
fi

# Check for token files
if echo "$STAGED_FILES" | grep -E "token\.txt$|secret\.txt$|key\.txt$" >/dev/null; then
    echo "üö® SECURITY ALERT: Token/secret files should not be committed!"
    echo "Found token files in staged changes:"
    echo "$STAGED_FILES" | grep -E "token\.txt$|secret\.txt$|key\.txt$"
    SECRETS_FOUND=1
fi

if [ $SECRETS_FOUND -eq 1 ]; then
    echo "‚ùå COMMIT BLOCKED: Potential secrets detected!"
    echo "Please remove secrets and use environment variables instead."
    echo "See docs/security/SECURE_ENVIRONMENT_SETUP.md for guidance."
    exit 1
fi

echo "‚úÖ No secrets detected in staged files"

# Run linting and type checking
# echo "Running linting and type checks..."
# npm run check:types
echo "Skipping type checks temporarily..."

echo "‚úÖ Pre-commit checks passed"