#!/bin/bash
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-commit security checks..."

# Check for exposed secrets
echo "Checking for exposed secrets..."

# Common secret patterns
SECRET_PATTERNS=(
    "sk_live_"
    "pk_live_"
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9"
    "supabase\.co"
    "SUPABASE_SERVICE_KEY=[^_]"
    "JWT_SECRET=[a-zA-Z0-9]{32,}"
    "password\s*[=:]\s*['\"][^'\"]{8,}['\"]"
    "secret\s*[=:]\s*['\"][^'\"]{8,}['\"]"
    "token\s*[=:]\s*['\"][^'\"]{16,}['\"]"
    "key\s*[=:]\s*['\"][^'\"]{16,}['\"]"
)

# Check staged files
STAGED_FILES=$(git diff --cached --name-only)
SECRETS_FOUND=0

for pattern in "${SECRET_PATTERNS[@]}"; do
    if echo "$STAGED_FILES" | xargs grep -l "$pattern" 2>/dev/null; then
        echo "üö® SECURITY ALERT: Potential secret found matching pattern: $pattern"
        echo "Files containing potential secrets:"
        echo "$STAGED_FILES" | xargs grep -l "$pattern" 2>/dev/null
        SECRETS_FOUND=1
    fi
done

# Check for .env files
if echo "$STAGED_FILES" | grep -E "\.env$|\.env\.production$|\.env\.local$" >/dev/null; then
    echo "üö® SECURITY ALERT: .env files should not be committed!"
    echo "Found .env files in staged changes:"
    echo "$STAGED_FILES" | grep -E "\.env$|\.env\.production$|\.env\.local$"
    SECRETS_FOUND=1
fi

# Check for token files
if echo "$STAGED_FILES" | grep -E "token\.txt$|secret\.txt$|key\.txt$" >/dev/null; then
    echo "üö® SECURITY ALERT: Token/secret files should not be committed!"
    echo "Found token files in staged changes:"
    echo "$STAGED_FILES" | grep -E "token\.txt$|secret\.txt$|key\.txt$"
    SECRETS_FOUND=1
fi

if [ $SECRETS_FOUND -eq 1 ]; then
    echo "‚ùå COMMIT BLOCKED: Potential secrets detected!"
    echo "Please remove secrets and use environment variables instead."
    echo "See docs/security/SECURE_ENVIRONMENT_SETUP.md for guidance."
    exit 1
fi

echo "‚úÖ No secrets detected in staged files"

# Run linting and type checking
echo "Running linting and type checks..."
npm run check:types

echo "‚úÖ Pre-commit checks passed"